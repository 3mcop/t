<?php

/**
 * @file
 * Show a modal overlay asking for postcode/login/signup
 */

function lt_overlay_menu() {
  return array(
    'guest' => array(
      'description' => 'Options for guests',
      'access callback' => 'user_is_anonymous',
      'title' => 'Guest options',
      'page callback' => '_lt_guest_options_page',
      'type' => MENU_NORMAL_ITEM,
    ),
    'guest/stop-overlay-inject' => array(
      'description' => 'Stop injecting the overlay',
      'access callback' => TRUE,
      'page callback' => '_lt_overlay_stop_inject',
      'type' => MENU_CALLBACK,
    ),
  );
}

function _lt_guest_options_page() {
  return drupal_get_form( 'lt_overlay_postcode_form' );
}

function lt_overlay_should_show() {
  return
    user_is_anonymous() &&
    ! postcode_exists() &&
    arg(0) != 'user' &&
    arg(0) != 'guest'
    ;
}

function lt_overlay_preprocess_page( &$variables ) {

  $should_show = lt_overlay_should_show();
  $variables['lt_overlay']['show it?'] = $should_show;

  if ( $should_show ) {
    $variables['lt_overlay']['postcode_form'] =
      drupal_get_form( 'lt_overlay_postcode_form' );
    $variables['lt_overlay']['login_form'] =
      drupal_get_form( 'user_login' );
  }
}


/*
function lt_overlay_close_button() {

  return array(
    'close-button' => array(
      '#type' => 'submit',
      '#value' => 'x',
      '#attributes' => array(
        'class' => array( 'close' ),
        'data-dismiss' => 'modal',
      ),
    ),
  );
}

function lt_overlay_close_button_submit() {
}
 */


function lt_overlay_postcode_form( $form, &$form_state ) {

  return array(
    'postcode' => array(
      '#type' => 'textfield',
      '#title' => t('Enter your postcode'),
      '#attributes' => array( 'placeholder' => t('Enter postcode') ),
    ),
    'submit' => array(
      '#type' => 'submit',
      '#value' => t('Go'),
    ),
  );
}

function lt_overlay_postcode_form_validate( $form, &$form_state ) {
  if ( empty( $form_state['values']['postcode'] ) ) {
    form_set_error( 'postcode', t( 'You must enter a postcode.' ) );
  }
  else {
    $postcode = $form_state['values']['postcode'];
    if ( postcode_is_real_postcode( $postcode ) ) {
      $form_state['values']['postcode'] =
        postcode_clean_user_input( $postcode );
    }
    else {
      form_set_error( 'postcode', t( 'The postcode you entered does not seem to be valid.' ) );
    }
  }
}

function lt_overlay_postcode_form_submit( $form, &$form_state ) {
  postcode_set_guest_postcode( $form_state['values']['postcode'] );
}


function lt_overlay_form_user_login_alter( &$form, &$form_state ) {
  //$form['#validate'][] = 'lt_overlay_user_login_validate';
  //$form['#submit'][] = 'lt_overlay_user_login_submit';
}

/*
function lt_overlay_user_login_validate( $form, &$form_state ) {
}

function lt_overlay_user_login_submit( $form, &$form_state ) {
}
*/
